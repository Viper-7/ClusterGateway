# ClusterGateway
![Architecture](http://codepad.viper-7.com/clustercontrol.png)
This repository implements the 'Gateway Server' from the architecture diagram, which includes a Load Balancer, Intrusion Detection System, Logging system, Host based bandwidth accounting engine, Server monitoring agent, and provides hosting for a command & control web application instance.
Provision is also provided for a static content cache, which can be used as a simple optimization step for web sites or web applications written in any language.

The purpose of this device is to integrate these typically disparate systems, to provide security via advanced intrusion detection and intrustion protection features, while lowering operating costs and potentially even boosting performance.
It achieves these goals by utilizing a network of services communicating via non-blocking IO, provided by the ZeroMQ messaging library. As a request is processed, it is immediately allocated to a back-end server for processing. While waiting for the back-end server, a message containing the request details is then passed to the Intrusion Detection System to be checked for abuse, and to the log transcriber which will take note of any unusual requests.
A similar thing occurs in handling the response, this time first delivering the response to the client, then handling bandwidth accounting and server error logging. This entire process occurs in memory, avoiding the traditional overheads of writing to and parsing log files, and all delays from polling based systems.
Also thanks to the asynchronous behaviour, when abuse is detected another message is passed from the IDS to a system management service, which can take immediate action, potentially even impacting the response of the very request that triggered the alert.
This would traditionally require the abuse detection to be "in-band", slowing down the overall response time. With this system the process happens entirely in the background, meaning performance is nearly identical to a traditional "dumb" load balancer.

This system employs a newly designed Intrusion Detection System, based on the tried & tested rules from PHPIDS, and providing a wide range of intrustion *prevention* actions which are available upon detection of abuse.
These actions start from simple obfuscation such as rewriting the HTTP status code, which is a simple method to confuse (or entirely crash) most automated vulnerability scanners and pre-built hacking tools, yet has zero impact on client experience on any major browser if a user is accidentally flagged.
Following this, the system can engage a captive portal for the user's IP address, forwarding all their requests to an internal server which presents them with a Captcha. If they pass the Captcha their access is restored. This has the advantage of removing the attacker's load from the back-end servers, while automatically self-healing a falsely detected Denial of Service attack in periods of extreme load.
If an automated attack persists for a long time, or an attack is detected outside of the application layer, the system can then use iptables firewall rules to drop incoming packets from abusive IPs. These bans are time limited by default to limit blocking access to legitimate users who might potentially share that IP (eg, Users of internet providers with transparent proxies.)
Finally, the iptables firewall is monitored using the same high-speed, memory-based messaging system, and if the dropped packet rate exceeds a certain threshold, indicating a high or extreme bandwidth denial of service attack, the system can then use the API's provided by cloud hosting vendors such as Amazon or Rackspace to block the IP at their routers.
At this point, if an attack persists and manages to still take down your website, they have most likely taken down the entire cloud hosting infrastruture you reside on, effectively meaning it's now a problem for their technicians, not you ;)
